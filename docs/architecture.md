# Архитектура проекта

## Обзор

**Shaurmania** — это веб-приложение для заказа шаурмы с доставкой, построенное
на Django 6.0. Проект использует модульную архитектуру с разделением
функциональности по приложениям.

## Технологический стек

### Backend

- **Django 6.0** — основной фреймворк
- **SQLite3** — база данных (для разработки)
- **Jinja2** — система шаблонов (через django-jinja)
- **django-imagekit** — обработка изображений
- **django-compressor** — сжатие статических файлов

### Frontend

- **Jinja2** — шаблонизатор
- **SCEditor** — WYSIWYG редактор
- **Tiny Slider** — слайдеры

### Дополнительные компоненты

- **aiogram 3.x** — Telegram бот
- **pytest** — тестирование
- **Factory Boy** — генерация тестовых данных
- **MaxMind GeoIP2** — определение геолокации по IP

## Структура приложений

Проект состоит из следующих Django-приложений:

### 1. `main` — Основное приложение

Ключевое приложение проекта, содержащее:

- Модели пользователей (`User`, `UserAvatar`, `UserAddress`)
- Каталог товаров (`Shaurma`, `ShaurmaCategory`, `ShaurmaImage`)
- Систему отзывов (`Review`)
- Локации доставки (`Location`)
- Достижения (`Achievement`, `UserAchievement`)
- Новости (`News`, `NewsTag`)
- Акции (`Stock`)
- Доставку (`Delivery`)

### 2. `cart` — Корзина и заказы

Управление корзиной покупок:

- Модель корзины (`Cart`)
- Заказы (`Order`)
- Промокоды (`Promocode`)

### 3. `geodata` — Геоданные

Система работы с географическими данными:

- Иерархия географических объектов (страны, регионы, города, улицы)
- Адреса (`Address`, `BaseAddress`)
- Часовые пояса (`TimeZone`)
- Геокодирование (определение координат по адресу)

### 4. `security` — Безопасность

Система безопасности и мониторинга:

- Логирование авторизаций (`SecurityAuthLog`)
- Устройства пользователей (`SecurityDevice`)
- Уведомления безопасности (`SecurityNotice`, `SecurityAction`)

### 5. `api` — API

REST API для административных функций:

- Генерация тестовых данных через Factory Boy
- Геокодирование по IP

### 6. `bot` — Telegram бот

Telegram бот на aiogram 3.x для взаимодействия с пользователями

## Паттерны проектирования

### Модели

- Использование кастомной модели пользователя (`AUTH_USER_MODEL = 'main.User'`)
- ImageKit для автоматической обработки изображений
- Денормализация данных в моделях адресов для оптимизации

### Представления (Views)

- Функциональные представления
- Разделение логики по модулям (`main/views/`)

### Шаблоны

- Jinja2 как основной шаблонизатор
- Расширение `.jinja` для шаблонов
- Компрессия статических файлов через django-compressor

### Безопасность

- Логирование всех действий безопасности
- Отслеживание устройств пользователей
- Валидация данных на уровне моделей и форм

## Потоки данных

### Регистрация пользователя

1. Пользователь заполняет форму регистрации
2. Валидация данных (возраст, стоп-слова, email)
3. Создание записи в `User`
4. Логирование в `SecurityAuthLog`
5. Создание записи устройства в `SecurityDevice`

### Процесс заказа

1. Пользователь добавляет товары в корзину (`Cart`)
2. Выбор адреса доставки (`UserAddress` или `Location`)
3. Применение промокода (если есть)
4. Создание заказа (`Order`)
5. Очистка корзины

### Геокодирование

1. Пользователь вводит адрес
2. Поиск улицы в базе `GeoStreet`
3. Геокодирование через внешний API (`Geocoder`)
4. Сохранение координат в `BaseAddress` или `Address`

## Логирование

Система логирования разделена по категориям:

- `logs/logs.log` — основные логи
- `logs/django/` — логи Django
- `logs/security/` — логи безопасности
- `logs/database/` — логи базы данных
- `logs/server/` — логи сервера
- `logs/third-party/` — логи сторонних библиотек
- `logs/errors.log` — только ошибки

## Кэширование

- Bytecode cache для Jinja2 шаблонов
- Кэш изображений через ImageKit
- Сжатие статических файлов через django-compressor

## Масштабируемость

### Текущие ограничения

- SQLite3 подходит для разработки и небольших проектов
- Для продакшена рекомендуется PostgreSQL

### Рекомендации для продакшена

- Использование PostgreSQL или MySQL
- Настройка Redis для кэширования
- Использование Celery для фоновых задач
- Настройка CDN для статических файлов
- Использование Gunicorn + Nginx

